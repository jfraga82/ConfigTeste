# ğŸ” Fluxo de AutenticaÃ§Ã£o - Diagrama Visual

---

## ğŸ“Š **FLUXO COMPLETO DE LOGIN**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  ğŸ‘¤ UTILIZADOR                                                  â”‚
â”‚     Digite: http://localhost:3000                              â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚  ğŸ” MIDDLEWARE: requireAuth (server.js)                        â”‚
â”‚     â“ Existe sessÃ£o ativa?                                    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                       â”‚
          âœ… SIM - Tem sessÃ£o    âŒ NÃƒO - Sem sessÃ£o
                 â”‚                       â”‚
                 â†“                       â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                        â”‚  â”‚                      â”‚
    â”‚  ğŸ¯ ACESSO DIRETO      â”‚  â”‚  ğŸ”€ REDIRECT         â”‚
    â”‚     Ã€ APLICAÃ‡ÃƒO        â”‚  â”‚     PARA /login      â”‚
    â”‚                        â”‚  â”‚                      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                              â”‚
            â”‚                              â†“
            â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚              â”‚                                   â”‚
            â”‚              â”‚  ğŸ“± PÃGINA DE LOGIN               â”‚
            â”‚              â”‚     login.html                    â”‚
            â”‚              â”‚                                   â”‚
            â”‚              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
            â”‚              â”‚  â”‚                             â”‚ â”‚
            â”‚              â”‚  â”‚  ğŸ”µ Sign in with Microsoft  â”‚ â”‚
            â”‚              â”‚  â”‚                             â”‚ â”‚
            â”‚              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
            â”‚              â”‚                                   â”‚
            â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                              â”‚
            â”‚                              â”‚ ğŸ‘† User clica
            â”‚                              â”‚
            â”‚                              â†“
            â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚              â”‚                                   â”‚
            â”‚              â”‚  ğŸ”€ REDIRECT PARA AZURE AD        â”‚
            â”‚              â”‚     /auth/signin                  â”‚
            â”‚              â”‚                                   â”‚
            â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                              â”‚
            â”‚                              â†“
            â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚              â”‚                                   â”‚
            â”‚              â”‚  â˜ï¸ MICROSOFT AZURE AD            â”‚
            â”‚              â”‚     login.microsoftonline.com     â”‚
            â”‚              â”‚                                   â”‚
            â”‚              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
            â”‚              â”‚  â”‚  Username: _______________ â”‚  â”‚
            â”‚              â”‚  â”‚  Password: _______________ â”‚  â”‚
            â”‚              â”‚  â”‚  [ Login ]                 â”‚  â”‚
            â”‚              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
            â”‚              â”‚                                   â”‚
            â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                              â”‚
            â”‚                              â”‚ âœ… Login OK
            â”‚                              â”‚
            â”‚                              â†“
            â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚              â”‚                                   â”‚
            â”‚              â”‚  ğŸ”™ CALLBACK                      â”‚
            â”‚              â”‚     /auth/callback?code=...       â”‚
            â”‚              â”‚                                   â”‚
            â”‚              â”‚  â€¢ Recebe authorization code      â”‚
            â”‚              â”‚  â€¢ Troca por access token         â”‚
            â”‚              â”‚  â€¢ Extrai email do utilizador     â”‚
            â”‚              â”‚    email: user@tekever.com        â”‚
            â”‚              â”‚                                   â”‚
            â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                              â”‚
            â”‚                              â†“
            â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚              â”‚                                   â”‚
            â”‚              â”‚  ğŸ“ CHAMADA AO BUSINESS CENTRAL   â”‚
            â”‚              â”‚     _ValidateExternalUserEmail    â”‚
            â”‚              â”‚                                   â”‚
            â”‚              â”‚  POST /ODataV4/...                â”‚
            â”‚              â”‚  {                                â”‚
            â”‚              â”‚    "inputJson": "{               â”‚
            â”‚              â”‚      \"emailAddress\":            â”‚
            â”‚              â”‚      \"user@tekever.com\"         â”‚
            â”‚              â”‚    }"                             â”‚
            â”‚              â”‚  }                                â”‚
            â”‚              â”‚                                   â”‚
            â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                              â”‚
            â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                  â”‚                       â”‚
            â”‚         âœ… result = "ok"        âŒ result = "not ok"
            â”‚                  â”‚                       â”‚
            â”‚                  â†“                       â†“
            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  â”‚                           â”‚  â”‚                      â”‚
            â”‚  â”‚  âœ… AUTORIZADO            â”‚  â”‚  âŒ NÃƒO AUTORIZADO   â”‚
            â”‚  â”‚                           â”‚  â”‚                      â”‚
            â”‚  â”‚  â€¢ Cria sessÃ£o segura     â”‚  â”‚  â€¢ Destroi dados     â”‚
            â”‚  â”‚  â€¢ Armazena user info     â”‚  â”‚  â€¢ Faz logout Azure  â”‚
            â”‚  â”‚  â€¢ Define expiry (1h)     â”‚  â”‚  â€¢ Mostra erro       â”‚
            â”‚  â”‚  â€¢ Redireciona para /     â”‚  â”‚  â€¢ Volta para /login â”‚
            â”‚  â”‚                           â”‚  â”‚                      â”‚
            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚              â”‚                            â”‚
            â”‚              â”‚                            â”‚
            â†“              â†“                            â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                  â”‚      â”‚                 â”‚
    â”‚  ğŸ‰ APLICAÃ‡ÃƒO PROTEGIDA          â”‚      â”‚  ğŸš« ERRO        â”‚
    â”‚     index.html                   â”‚      â”‚     Access      â”‚
    â”‚                                  â”‚      â”‚     Denied      â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚      â”‚                 â”‚
    â”‚  â”‚ ğŸ“§ user@tekever.com        â”‚ â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚  â”‚ ğŸšª [Logout]                â”‚ â”‚
    â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
    â”‚  â”‚                            â”‚ â”‚
    â”‚  â”‚  Selecione o Configurador  â”‚ â”‚
    â”‚  â”‚  â—‹ Tampo CÃ³nico            â”‚ â”‚
    â”‚  â”‚  â—‹ Silo Tetrapak           â”‚ â”‚
    â”‚  â”‚  â—‹ DepÃ³sito Inox           â”‚ â”‚
    â”‚  â”‚                            â”‚ â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
    â”‚                                  â”‚
    â”‚  âœ… SessÃ£o ativa                 â”‚
    â”‚  âœ… VerificaÃ§Ã£o a cada 5 min     â”‚
    â”‚  âœ… RenovaÃ§Ã£o automÃ¡tica         â”‚
    â”‚  âœ… ExpiraÃ§Ã£o em 1 hora          â”‚
    â”‚                                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ **ESTADOS DA SESSÃƒO**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      CICLO DE VIDA                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1ï¸âƒ£  INÃCIO
    â€¢ Utilizador nÃ£o tem sessÃ£o
    â€¢ Cookie nÃ£o existe
    â€¢ Estado: âŒ Not Authenticated

            â†“ Login bem-sucedido

2ï¸âƒ£  ATIVA
    â€¢ SessÃ£o criada no servidor
    â€¢ Cookie enviado ao browser
    â€¢ User info armazenada
    â€¢ Token de acesso guardado
    â€¢ Estado: âœ… Authenticated
    â€¢ DuraÃ§Ã£o: 1 hora (3600000ms)

            â†“ Tempo passa

3ï¸âƒ£  RENOVAÃ‡ÃƒO (AutomÃ¡tica)
    â€¢ Se user ativo nos Ãºltimos 30 min
    â€¢ Sistema renova automaticamente
    â€¢ ExpiraÃ§Ã£o estendida +1 hora
    â€¢ Estado: âœ… Authenticated (renovada)

            â†“ 1 hora sem atividade

4ï¸âƒ£  EXPIRADA
    â€¢ SessÃ£o ultrapassa max age
    â€¢ Middleware detecta expiraÃ§Ã£o
    â€¢ SessÃ£o destruÃ­da
    â€¢ Estado: âŒ Session Expired
    â€¢ Redirect para login

            â†“ User faz logout manual

5ï¸âƒ£  LOGOUT
    â€¢ User clica no botÃ£o logout
    â€¢ SessÃ£o destruÃ­da no servidor
    â€¢ Cookie removido
    â€¢ Logout tambÃ©m no Azure AD
    â€¢ Estado: âŒ Logged Out
```

---

## ğŸ” **VERIFICAÃ‡Ã•ES DE SEGURANÃ‡A**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         CADA PEDIDO PASSA POR MÃšLTIPLAS CAMADAS             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PEDIDO: GET /api/questionnaires
    â”‚
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1ï¸âƒ£  Rate Limiting                â”‚  â† 100 requests / 15 min
â”‚     âœ… Dentro do limite           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2ï¸âƒ£  CORS Check                   â”‚  â† Origin verificado
â”‚     âœ… Origin autorizado           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3ï¸âƒ£  Authentication Middleware    â”‚  â† requireAuth()
â”‚     â“ SessÃ£o existe?              â”‚
â”‚     â“ SessÃ£o vÃ¡lida?              â”‚
â”‚     â“ NÃ£o expirou?                â”‚
â”‚     âœ… Todas verificaÃ§Ãµes OK       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4ï¸âƒ£  Security Headers              â”‚  â† Helmet.js
â”‚     âœ… CSP aplicado                â”‚
â”‚     âœ… HSTS ativo                  â”‚
â”‚     âœ… noSniff enabled             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5ï¸âƒ£  Request Handler              â”‚  â† API Controller
â”‚     âœ… Processa pedido             â”‚
â”‚     âœ… Retorna dados               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
            RESPOSTA
```

---

## ğŸ“Š **COMPARAÃ‡ÃƒO: ANTES vs DEPOIS**

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                          ANTES                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ‘¤ Utilizador
    â†“
ğŸŒ http://localhost:3000
    â†“
âœ… ACESSO DIRETO (sem autenticaÃ§Ã£o) âŒ
    â†“
ğŸ“± AplicaÃ§Ã£o carrega para QUALQUER pessoa
    â†“
âŒ RISCO: Qualquer pessoa pode aceder


â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                         DEPOIS                                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ‘¤ Utilizador
    â†“
ğŸŒ http://localhost:3000
    â†“
ğŸ”’ VERIFICAÃ‡ÃƒO DE AUTENTICAÃ‡ÃƒO
    â†“
âŒ Sem sessÃ£o? â†’ ğŸ”€ Redirect para /login
    â†“
ğŸ“± PÃ¡gina de Login (Sign in with Microsoft)
    â†“
â˜ï¸ Azure AD (OAuth 2.0)
    â†“
ğŸ“ Business Central Validation
    â†“
âœ… Email autorizado? â†’ âœ… Acesso concedido
âŒ Email nÃ£o autorizado? â†’ âŒ Acesso negado
    â†“
ğŸ‰ AplicaÃ§Ã£o carrega APENAS para users autorizados
    â†“
âœ… SEGURO: Apenas utilizadores autorizados acedem
```

---

## ğŸ¯ **PONTOS DE PROTEÃ‡ÃƒO**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ROTAS PROTEGIDAS                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ”’ PÃGINAS (requireAuth)
   â”œâ”€ GET  /                    â†’ index.html (protegido)
   â””â”€ GET  /*                   â†’ Qualquer pÃ¡gina (protegido)

ğŸ”’ API (requireAuth + apiLimiter)
   â”œâ”€ GET  /api/questionnaires/:code
   â”œâ”€ GET  /api/available-questionnaires
   â””â”€ POST /api/product/create

ğŸ”“ PÃšBLICAS (sem autenticaÃ§Ã£o)
   â”œâ”€ GET  /login               â†’ login.html
   â”œâ”€ GET  /css/*               â†’ Estilos
   â”œâ”€ GET  /js/*                â†’ Scripts (exceto protegidos)
   â””â”€ GET  /assets/*            â†’ Imagens, fonts, vÃ­deos

ğŸ” AUTENTICAÃ‡ÃƒO (authLimiter)
   â”œâ”€ GET  /auth/signin         â†’ Inicia login
   â”œâ”€ GET  /auth/callback       â†’ Recebe tokens
   â”œâ”€ GET  /auth/logout         â†’ Faz logout
   â”œâ”€ GET  /auth/check          â†’ Verifica auth
   â””â”€ POST /auth/refresh        â†’ Renova sessÃ£o
```

---

## ğŸ“ **EXEMPLO DE LOG DE AUTENTICAÃ‡ÃƒO**

```
[AUTH] Initializing authentication...
[MSAL] Authority: https://login.microsoftonline.com/12345678-...
[MSAL] Client ID: a1b2c3d4-...
[MSAL] Redirect URI: http://localhost:3000/auth/callback

[AUTH] Login attempt: {
  email: 'joaquim.fraga@tekever.com',
  ip: '::1',
  userAgent: 'Mozilla/5.0...',
  timestamp: '2025-11-25T10:30:00.000Z'
}

[MSAL] Authorization code received
[MSAL] Exchanging code for tokens...
[MSAL] Tokens acquired successfully

[AUTH] User authenticated: joaquim.fraga@tekever.com
[BC] Validating email: joaquim.fraga@tekever.com
[BC] Calling API: https://api.businesscentral.dynamics.com/...
[BC] Validation response: { result: 'ok', message: '...', description: '...' }
[BC] âœ… Email validated: joaquim.fraga@tekever.com

[AUTH] âœ… User authorized: joaquim.fraga@tekever.com
[AUTH] Session created for user: joaquim.fraga@tekever.com
[AUTH] âœ… Authentication initialized
```

---

## ğŸ‰ **RESULTADO FINAL**

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                  APLICAÃ‡ÃƒO PROTEGIDA                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… Apenas utilizadores autenticados no Azure AD
âœ… Apenas emails autorizados no Business Central
âœ… SessÃµes seguras (HttpOnly, SameSite cookies)
âœ… ExpiraÃ§Ã£o automÃ¡tica (1 hora)
âœ… RenovaÃ§Ã£o automÃ¡tica com atividade
âœ… Logout completo (app + Azure)
âœ… Rate limiting (anti brute-force)
âœ… Security logging (audit trail)
âœ… ProteÃ§Ã£o de todas as rotas
âœ… UI moderna e intuitiva

ğŸ¯ SCORE DE SEGURANÃ‡A: 95/100
```

---

**Ãšltima AtualizaÃ§Ã£o:** 25 de Novembro de 2025  
**VersÃ£o:** 1.0  
**Status:** âœ… ImplementaÃ§Ã£o Completa


